#!/bin/bash
# PostgreSQL Backup Script

BACKUP_DIR="{{ backup_dir }}/postgresql"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS={{ backup_retention_days }}

# Create backup
{% for db in postgresql_databases %}
pg_dump {{ db.name }} | gzip > "${BACKUP_DIR}/{{ db.name }}_${TIMESTAMP}.sql.gz"
{% endfor %}

# Remove old backups
find "${BACKUP_DIR}" -name "*.sql.gz" -mtime +${RETENTION_DAYS} -delete

# Log
echo "$(date): PostgreSQL backup completed" >> /var/log/postgresql_backup.log
