---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: [packages, apt, update]

- name: Wait for dpkg/apt locks to be released
  shell: |
    timeout=300
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \
          fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
      echo "Waiting for apt/dpkg lock... (timeout in ${timeout}s)"
      sleep 2
      timeout=$((timeout - 2))
      if [ $timeout -le 0 ]; then
        echo "ERROR: Timeout waiting for apt lock after 300s"
        # Kill processes holding locks (last resort)
        pkill -9 apt-get || true
        pkill -9 dpkg || true
        sleep 2
        exit 1
      fi
    done
    echo "All dpkg/apt locks released"
  changed_when: false
  tags: [packages, apt]

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  retries: 3
  delay: 10
  register: apt_upgrade_result
  until: apt_upgrade_result is success
  tags: [packages, apt, upgrade]

- name: Install common packages
  apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - net-tools
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - python3
      - python3-pip
      - acl
      - rsync
      - unzip
      - cron
      - tzdata
    state: present
  ignore_errors: yes
  tags: [packages, tools]

- name: Set timezone
  timezone:
    name: "{{ timezone | default('UTC') }}"
  when: timezone is defined and timezone != ""
  ignore_errors: yes
  tags: [config, timezone]

- name: Create deploy user
  user:
    name: "{{ deploy_user }}"
    groups: "{{ deploy_user_groups }}"
    shell: /bin/bash
    create_home: yes
    state: present
  tags: [users, deploy]

- name: Add SSH key for deploy user
  authorized_key:
    user: "{{ deploy_user }}"
    key: "{{ lookup('file', ssh_key_path) }}"
    state: present
  when: ssh_key_path is defined and ssh_key_path != ""
  tags: [users, deploy, ssh]

- name: Allow deploy user to sudo without password
  lineinfile:
    path: /etc/sudoers.d/{{ deploy_user }}
    line: "{{ deploy_user }} ALL=(ALL) NOPASSWD:ALL"
    create: yes
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: [users, deploy, sudo]

- name: Configure systemd journal retention
  lineinfile:
    path: /etc/systemd/journald.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^#?SystemMaxUse=', line: 'SystemMaxUse=500M' }
    - { regexp: '^#?MaxRetentionSec=', line: 'MaxRetentionSec=1month' }
  notify: restart journald
  tags: [config, logs, systemd]
