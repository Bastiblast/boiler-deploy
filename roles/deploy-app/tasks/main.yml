---
- name: Get latest commit hash
  shell: "git ls-remote {{ app_repo }} {{ app_branch }} | awk '{print $1}'"
  register: git_commit
  delegate_to: localhost
  become: no

- name: Set release name
  set_fact:
    release_name: "{{ ansible_date_time.iso8601_basic_short }}_{{ git_commit.stdout[:7] }}"
    release_path: "{{ app_releases_dir }}/{{ ansible_date_time.iso8601_basic_short }}_{{ git_commit.stdout[:7] }}"

- name: Clone repository
  git:
    repo: "{{ app_repo }}"
    dest: "{{ release_path }}"
    version: "{{ app_branch }}"
    accept_hostkey: yes
  become: yes
  become_user: "{{ deploy_user }}"

- name: Link shared files
  file:
    src: "{{ app_shared_dir }}/config/.env"
    dest: "{{ release_path }}/.env"
    state: link
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"

# Detect application type and configuration
- name: Detect application type
  include_tasks: detect-app-type.yml

# Install Node.js version required by the project
- name: Check if required Node.js version is installed
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm ls {{ required_node_version }} | grep -q "{{ required_node_version }}"
  become: yes
  become_user: "{{ deploy_user }}"
  register: node_version_check
  ignore_errors: yes
  changed_when: false

- name: Install required Node.js version via NVM
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install {{ required_node_version }}
    nvm alias default {{ required_node_version }}
  become: yes
  become_user: "{{ deploy_user }}"
  when: node_version_check.rc != 0

- name: Install global packages (PM2 and package managers)
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Install global packages (PM2 and package managers)"
    nvm_command: "npm install -g pm2 pnpm yarn"
    nvm_condition: "{{ node_version_check.rc != 0 }}"
    nvm_tags: ['nodejs', 'packages', 'global']

- name: Setup PM2 startup script
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Setup PM2 startup script"
    nvm_command: "pm2 startup systemd -u {{ deploy_user }} --hp /home/{{ deploy_user }}"
    nvm_creates: "/etc/systemd/system/pm2-{{ deploy_user }}.service"
    nvm_ignore_errors: yes
    nvm_tags: ['nodejs', 'pm2', 'systemd']

# Install dependencies based on package manager
- name: Install dependencies with npm
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Install dependencies with npm"
    nvm_command: "npm install --production"
    nvm_chdir: "{{ release_path }}"
    nvm_condition: "{{ package_manager | default('npm') == 'npm' }}"
    nvm_tags: ['deploy', 'dependencies', 'npm']

- name: Install dependencies with pnpm (production only for standard apps)
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Install dependencies with pnpm (production only)"
    nvm_command: "pnpm install --prod"
    nvm_chdir: "{{ release_path }}"
    nvm_condition: "{{ (package_manager | default('npm') == 'pnpm') and (app_type | default('nodejs') not in ['nextjs', 'nuxtjs']) }}"
    nvm_tags: ['deploy', 'dependencies', 'pnpm']

- name: Install dependencies with pnpm (all deps for framework apps)
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Install dependencies with pnpm (all deps for frameworks)"
    nvm_command: "pnpm install --frozen-lockfile"
    nvm_chdir: "{{ release_path }}"
    nvm_condition: "{{ (package_manager | default('npm') == 'pnpm') and (app_type | default('nodejs') in ['nextjs', 'nuxtjs']) }}"
    nvm_tags: ['deploy', 'dependencies', 'pnpm', 'framework']

- name: Verify TypeScript installation for Next.js with TS config
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Verify TypeScript installation for Next.js"
    nvm_command: "pnpm list typescript || pnpm add -D typescript"
    nvm_chdir: "{{ release_path }}"
    nvm_condition: "{{ (package_manager | default('npm') == 'pnpm') and (app_type | default('nodejs') == 'nextjs') }}"
    nvm_changed_when: false
    nvm_ignore_errors: yes
    nvm_tags: ['deploy', 'typescript', 'nextjs']

- name: Install dependencies with yarn
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Install dependencies with yarn"
    nvm_command: "yarn install --production"
    nvm_chdir: "{{ release_path }}"
    nvm_condition: "{{ package_manager | default('npm') == 'yarn' }}"
    nvm_tags: ['deploy', 'dependencies', 'yarn']

# Build application if needed
- name: Build application with npm
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Build application with npm"
    nvm_command: "npm run build"
    nvm_chdir: "{{ release_path }}"
    nvm_condition: "{{ (needs_build | default(false)) and (package_manager | default('npm') == 'npm') }}"
    nvm_tags: ['deploy', 'build', 'npm']

- name: Build application with pnpm
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Build application with pnpm"
    nvm_command: "pnpm run build"
    nvm_chdir: "{{ release_path }}"
    nvm_condition: "{{ (needs_build | default(false)) and (package_manager | default('npm') == 'pnpm') }}"
    nvm_tags: ['deploy', 'build', 'pnpm']

- name: Build application with yarn
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "Build application with yarn"
    nvm_command: "yarn build"
    nvm_chdir: "{{ release_path }}"
    nvm_condition: "{{ (needs_build | default(false)) and (package_manager | default('npm') == 'yarn') }}"
    nvm_tags: ['deploy', 'build', 'yarn']

# Create PM2 config based on app type
- name: Create PM2 ecosystem file for Next.js
  template:
    src: ecosystem.config.nextjs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') == 'nextjs'

- name: Create PM2 ecosystem file for Nuxt.js
  template:
    src: ecosystem.config.nuxtjs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') == 'nuxtjs'

- name: Create PM2 ecosystem file for Node.js
  template:
    src: ecosystem.config.nodejs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') in ['nodejs', 'express', 'fastify', 'nestjs', 'unknown']

- name: Update symlink to current release
  file:
    src: "{{ release_path }}"
    dest: "{{ app_current_dir }}"
    state: link
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"

- name: Check if PM2 dump file exists (indicates saved apps)
  stat:
    path: "/home/{{ deploy_user }}/.pm2/dump.pm2"
  register: pm2_dump_file
  become: yes
  become_user: "{{ deploy_user }}"

- name: Read PM2 dump to check if app exists
  slurp:
    src: "/home/{{ deploy_user }}/.pm2/dump.pm2"
  register: pm2_dump_content
  become: yes
  become_user: "{{ deploy_user }}"
  when: pm2_dump_file.stat.exists
  ignore_errors: yes

- name: Determine if app is already in PM2
  set_fact:
    pm2_running:
      rc: "{{ 0 if (pm2_dump_file.stat.exists and pm2_dump_content.content | default('') | b64decode | regex_search(pm2_app_name)) else 1 }}"
  changed_when: false

- name: Determine PM2 action (start or reload)
  set_fact:
    pm2_action: "{{ 'reload' if pm2_running.rc == 0 else 'start' }}"

- name: Start or reload application with PM2
  include_tasks: nvm-exec.yml
  vars:
    nvm_task_name: "{{ pm2_action | capitalize }} application with PM2"
    nvm_command: "pm2 {{ pm2_action }} ecosystem.config.js && pm2 save"
    nvm_chdir: "{{ app_current_dir }}"
    nvm_tags: ['deploy', 'pm2', 'start']

- name: Wait for application to start
  wait_for:
    port: "{{ app_port }}"
    delay: 5
    timeout: 60

- name: Find all releases
  find:
    paths: "{{ app_releases_dir }}"
    file_type: directory
    recurse: no
  register: all_releases
  tags: [deploy, cleanup]

- name: Sort releases by modification time and identify old ones
  set_fact:
    old_releases: "{{ (all_releases.files | sort(attribute='mtime', reverse=true))[5:] }}"
  when: all_releases.files | length > 5
  tags: [deploy, cleanup]

- name: Remove old releases (keep last 5)
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_releases | default([]) }}"
  when: old_releases is defined and old_releases | length > 0
  tags: [deploy, cleanup]

- name: Display deployment info
  debug:
    msg:
      - "Application deployed successfully!"
      - "Release: {{ release_name }}"
      - "Path: {{ release_path }}"
      - "Current: {{ app_current_dir }}"
