---
- name: Get latest commit hash
  shell: "git ls-remote {{ app_repo }} {{ app_branch }} | awk '{print $1}'"
  register: git_commit
  delegate_to: localhost
  become: no

- name: Set release name
  set_fact:
    release_name: "{{ ansible_date_time.iso8601_basic_short }}_{{ git_commit.stdout[:7] }}"
    release_path: "{{ app_releases_dir }}/{{ ansible_date_time.iso8601_basic_short }}_{{ git_commit.stdout[:7] }}"

- name: Clone repository
  git:
    repo: "{{ app_repo }}"
    dest: "{{ release_path }}"
    version: "{{ app_branch }}"
    accept_hostkey: yes
  become: yes
  become_user: "{{ deploy_user }}"

- name: Link shared files
  file:
    src: "{{ app_shared_dir }}/config/.env"
    dest: "{{ release_path }}/.env"
    state: link
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"

# Detect application type and configuration
- name: Detect application type
  include_tasks: detect-app-type.yml

# Install dependencies based on package manager
- name: Install dependencies with npm
  npm:
    path: "{{ release_path }}"
    production: yes
    state: present
  become: yes
  become_user: "{{ deploy_user }}"
  when: package_manager | default('npm') == 'npm'

- name: Install dependencies with pnpm (production only for standard apps)
  shell: pnpm install --prod
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - package_manager | default('npm') == 'pnpm'
    - app_type | default('nodejs') not in ['nextjs', 'nuxtjs']

- name: Install dependencies with pnpm (all deps for framework apps)
  shell: pnpm install --frozen-lockfile
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - package_manager | default('npm') == 'pnpm'
    - app_type | default('nodejs') in ['nextjs', 'nuxtjs']

- name: Verify TypeScript installation for Next.js with TS config
  shell: pnpm list typescript || pnpm add -D typescript
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - package_manager | default('npm') == 'pnpm'
    - app_type | default('nodejs') == 'nextjs'
  changed_when: false
  ignore_errors: yes

- name: Install dependencies with yarn
  shell: yarn install --production
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: package_manager | default('npm') == 'yarn'

# Build application if needed
- name: Build application with npm
  shell: npm run build
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - needs_build | default(false)
    - package_manager | default('npm') == 'npm'

- name: Build application with pnpm
  shell: pnpm run build
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - needs_build | default(false)
    - package_manager | default('npm') == 'pnpm'

- name: Build application with yarn
  shell: yarn build
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - needs_build | default(false)
    - package_manager | default('npm') == 'yarn'

# Create PM2 config based on app type
- name: Create PM2 ecosystem file for Next.js
  template:
    src: ecosystem.config.nextjs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') == 'nextjs'

- name: Create PM2 ecosystem file for Nuxt.js
  template:
    src: ecosystem.config.nuxtjs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') == 'nuxtjs'

- name: Create PM2 ecosystem file for Node.js
  template:
    src: ecosystem.config.nodejs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') in ['nodejs', 'express', 'fastify', 'nestjs', 'unknown']

- name: Update symlink to current release
  file:
    src: "{{ release_path }}"
    dest: "{{ app_current_dir }}"
    state: link
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"

- name: Check if PM2 is already running the app
  shell: "pm2 list | grep -q {{ pm2_app_name }}"
  become: yes
  become_user: "{{ deploy_user }}"
  register: pm2_running
  ignore_errors: yes
  changed_when: false

- name: Start or reload application with PM2
  shell: |
    cd {{ app_current_dir }}
    {% if pm2_running.rc == 0 %}
    pm2 reload ecosystem.config.js
    {% else %}
    pm2 start ecosystem.config.js
    {% endif %}
    pm2 save
  become: yes
  become_user: "{{ deploy_user }}"
  environment:
    PATH: "/usr/bin:{{ ansible_env.PATH }}"

- name: Wait for application to start
  wait_for:
    port: "{{ app_port }}"
    delay: 5
    timeout: 60

- name: Keep only last 5 releases
  shell: "ls -1dt {{ app_releases_dir }}/* | tail -n +6 | xargs rm -rf"
  ignore_errors: yes

- name: Display deployment info
  debug:
    msg:
      - "Application deployed successfully!"
      - "Release: {{ release_name }}"
      - "Path: {{ release_path }}"
      - "Current: {{ app_current_dir }}"
