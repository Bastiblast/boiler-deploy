---
- name: Get latest commit hash
  shell: "git ls-remote {{ app_repo }} {{ app_branch }} | awk '{print $1}'"
  register: git_commit
  delegate_to: localhost
  become: no

- name: Set release name
  set_fact:
    release_name: "{{ ansible_date_time.iso8601_basic_short }}_{{ git_commit.stdout[:7] }}"
    release_path: "{{ app_releases_dir }}/{{ ansible_date_time.iso8601_basic_short }}_{{ git_commit.stdout[:7] }}"

- name: Clone repository
  git:
    repo: "{{ app_repo }}"
    dest: "{{ release_path }}"
    version: "{{ app_branch }}"
    accept_hostkey: yes
  become: yes
  become_user: "{{ deploy_user }}"

- name: Link shared files
  file:
    src: "{{ app_shared_dir }}/config/.env"
    dest: "{{ release_path }}/.env"
    state: link
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"

# Detect application type and configuration
- name: Detect application type
  include_tasks: detect-app-type.yml

# Install Node.js version required by the project
- name: Check if required Node.js version is installed
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm ls {{ required_node_version }} | grep -q "{{ required_node_version }}"
  become: yes
  become_user: "{{ deploy_user }}"
  register: node_version_check
  ignore_errors: yes
  changed_when: false

- name: Install required Node.js version via NVM
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install {{ required_node_version }}
    nvm alias default {{ required_node_version }}
  become: yes
  become_user: "{{ deploy_user }}"
  when: node_version_check.rc != 0

- name: Install global packages (PM2 and package managers)
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    npm install -g pm2 pnpm yarn
  become: yes
  become_user: "{{ deploy_user }}"
  when: node_version_check.rc != 0

- name: Setup PM2 startup script
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    pm2 startup systemd -u {{ deploy_user }} --hp /home/{{ deploy_user }}
  args:
    creates: /etc/systemd/system/pm2-{{ deploy_user }}.service
  ignore_errors: yes

# Install dependencies based on package manager
- name: Install dependencies with npm
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    npm install --production
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: package_manager | default('npm') == 'npm'

- name: Install dependencies with pnpm (production only for standard apps)
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    pnpm install --prod
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - package_manager | default('npm') == 'pnpm'
    - app_type | default('nodejs') not in ['nextjs', 'nuxtjs']

- name: Install dependencies with pnpm (all deps for framework apps)
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    pnpm install --frozen-lockfile
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - package_manager | default('npm') == 'pnpm'
    - app_type | default('nodejs') in ['nextjs', 'nuxtjs']

- name: Verify TypeScript installation for Next.js with TS config
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    pnpm list typescript || pnpm add -D typescript
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - package_manager | default('npm') == 'pnpm'
    - app_type | default('nodejs') == 'nextjs'
  changed_when: false
  ignore_errors: yes

- name: Install dependencies with yarn
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    yarn install --production
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: package_manager | default('npm') == 'yarn'

# Build application if needed
- name: Build application with npm
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    npm run build
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - needs_build | default(false)
    - package_manager | default('npm') == 'npm'

- name: Build application with pnpm
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    pnpm run build
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - needs_build | default(false)
    - package_manager | default('npm') == 'pnpm'

- name: Build application with yarn
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    yarn build
  args:
    chdir: "{{ release_path }}"
  become: yes
  become_user: "{{ deploy_user }}"
  when: 
    - needs_build | default(false)
    - package_manager | default('npm') == 'yarn'

# Create PM2 config based on app type
- name: Create PM2 ecosystem file for Next.js
  template:
    src: ecosystem.config.nextjs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') == 'nextjs'

- name: Create PM2 ecosystem file for Nuxt.js
  template:
    src: ecosystem.config.nuxtjs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') == 'nuxtjs'

- name: Create PM2 ecosystem file for Node.js
  template:
    src: ecosystem.config.nodejs.js.j2
    dest: "{{ release_path }}/ecosystem.config.js"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: '0644'
  when: app_type | default('nodejs') in ['nodejs', 'express', 'fastify', 'nestjs', 'unknown']

- name: Update symlink to current release
  file:
    src: "{{ release_path }}"
    dest: "{{ app_current_dir }}"
    state: link
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"

- name: Check if PM2 dump file exists (indicates saved apps)
  stat:
    path: "/home/{{ deploy_user }}/.pm2/dump.pm2"
  register: pm2_dump_file
  become: yes
  become_user: "{{ deploy_user }}"

- name: Read PM2 dump to check if app exists
  slurp:
    src: "/home/{{ deploy_user }}/.pm2/dump.pm2"
  register: pm2_dump_content
  become: yes
  become_user: "{{ deploy_user }}"
  when: pm2_dump_file.stat.exists
  ignore_errors: yes

- name: Determine if app is already in PM2
  set_fact:
    pm2_running:
      rc: "{{ 0 if (pm2_dump_file.stat.exists and pm2_dump_content.content | default('') | b64decode | regex_search(pm2_app_name)) else 1 }}"
  changed_when: false

- name: Start or reload application with PM2
  shell: |
    export NVM_DIR="/home/{{ deploy_user }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm use {{ required_node_version }}
    cd {{ app_current_dir }}
    {% if pm2_running.rc == 0 %}
    pm2 reload ecosystem.config.js
    {% else %}
    pm2 start ecosystem.config.js
    {% endif %}
    pm2 save
  become: yes
  become_user: "{{ deploy_user }}"

- name: Wait for application to start
  wait_for:
    port: "{{ app_port }}"
    delay: 5
    timeout: 60

- name: Find all releases
  find:
    paths: "{{ app_releases_dir }}"
    file_type: directory
    recurse: no
  register: all_releases
  tags: [deploy, cleanup]

- name: Sort releases by modification time and identify old ones
  set_fact:
    old_releases: "{{ (all_releases.files | sort(attribute='mtime', reverse=true))[5:] }}"
  when: all_releases.files | length > 5
  tags: [deploy, cleanup]

- name: Remove old releases (keep last 5)
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_releases | default([]) }}"
  when: old_releases is defined and old_releases | length > 0
  tags: [deploy, cleanup]

- name: Display deployment info
  debug:
    msg:
      - "Application deployed successfully!"
      - "Release: {{ release_name }}"
      - "Path: {{ release_path }}"
      - "Current: {{ app_current_dir }}"
