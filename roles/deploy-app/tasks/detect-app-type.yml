---
# Detect application type and set appropriate configuration

- name: Check if package.json exists
  stat:
    path: "{{ release_path }}/package.json"
  register: package_json_file

- name: Read package.json content
  slurp:
    src: "{{ release_path }}/package.json"
  register: package_json_content
  when: package_json_file.stat.exists

- name: Parse package.json
  set_fact:
    package_json: "{{ package_json_content.content | b64decode | from_json }}"
  when: package_json_file.stat.exists

- name: Detect application type (auto)
  set_fact:
    app_type_detected: >-
      {%- if package_json is defined -%}
        {%- if 'next' in (package_json.dependencies | default({})) or 'next' in (package_json.devDependencies | default({})) -%}
          nextjs
        {%- elif 'nuxt' in (package_json.dependencies | default({})) or 'nuxt' in (package_json.devDependencies | default({})) -%}
          nuxtjs
        {%- elif 'express' in (package_json.dependencies | default({})) -%}
          express
        {%- elif 'fastify' in (package_json.dependencies | default({})) -%}
          fastify
        {%- elif 'nest' in (package_json.dependencies | default({})) or '@nestjs/core' in (package_json.dependencies | default({})) -%}
          nestjs
        {%- else -%}
          nodejs
        {%- endif -%}
      {%- else -%}
        unknown
      {%- endif -%}
  when: package_json_file.stat.exists

- name: Set final application type (override or detected)
  set_fact:
    app_type: "{{ app_type_override | default(app_type_detected | default('nodejs')) }}"

- name: Check if pnpm-lock.yaml exists
  stat:
    path: "{{ release_path }}/pnpm-lock.yaml"
  register: pnpm_lock

- name: Check if yarn.lock exists
  stat:
    path: "{{ release_path }}/yarn.lock"
  register: yarn_lock

- name: Set package manager based on lock files (auto)
  set_fact:
    package_manager_detected: >-
      {%- if pnpm_lock.stat.exists -%}
        pnpm
      {%- elif yarn_lock.stat.exists -%}
        yarn
      {%- else -%}
        npm
      {%- endif -%}

- name: Set final package manager (override or detected)
  set_fact:
    package_manager: "{{ package_manager_override | default(package_manager_detected | default('npm')) }}"

- name: Detect if build is needed
  set_fact:
    needs_build: "{{ 'build' in (package_json.scripts | default({})) }}"
  when: package_json is defined

- name: Check for entry files
  stat:
    path: "{{ release_path }}/{{ item }}"
  register: entry_files_check
  loop:
    - index.js
    - server.js
    - app.js
    - src/index.js
    - src/server.js
    - src/app.js
  when: package_json is defined

- name: Detect main entry file (auto)
  set_fact:
    app_entry_file_detected: >-
      {%- if package_json is defined and package_json.main is defined -%}
        {{ package_json.main }}
      {%- else -%}
        {%- set found_file = entry_files_check.results | selectattr('stat.exists') | map(attribute='item') | list | first | default('index.js') -%}
        {{ found_file }}
      {%- endif -%}
  when: package_json is defined

- name: Set final entry file (override or detected)
  set_fact:
    app_entry_file: "{{ app_entry_file_override | default(app_entry_file_detected | default('index.js')) }}"

- name: Detect required Node.js version from package.json
  set_fact:
    required_node_version: >-
      {%- if package_json is defined and package_json.engines is defined and package_json.engines.node is defined -%}
        {{ package_json.engines.node | regex_replace('[^0-9.]', '') | regex_replace('^([0-9]+).*', '\\1') }}
      {%- else -%}
        20
      {%- endif -%}
  when: package_json is defined

- name: Set default Node.js version if not detected
  set_fact:
    required_node_version: "20"
  when: required_node_version is not defined

- name: Display detected configuration
  debug:
    msg:
      - "Application Type: {{ app_type | default('unknown') }}"
      - "Package Manager: {{ package_manager | default('npm') }}"
      - "Needs Build: {{ needs_build | default(false) }}"
      - "Entry File: {{ app_entry_file | default('N/A') }}"
      - "Node.js Version: {{ required_node_version }}"
      - "Has package.json: {{ package_json_file.stat.exists }}"
