---
- name: Update application
  hosts: webservers
  become: yes
  serial: 1

  tasks:
    - name: Pull latest code
      git:
        repo: "{{ app_repo }}"
        dest: "{{ app_current_dir }}"
        version: "{{ app_branch }}"
        update: yes
      become: yes
      become_user: "{{ deploy_user }}"

    - name: Install/update dependencies
      npm:
        path: "{{ app_current_dir }}"
        production: yes
        state: latest
      become: yes
      become_user: "{{ deploy_user }}"

    - name: Check if build script exists
      shell: grep -q '"build"' "{{ app_current_dir }}/package.json"
      register: has_build_script
      ignore_errors: yes
      become: yes
      become_user: "{{ deploy_user }}"
      changed_when: false

    - name: Build application
      shell: npm run build
      args:
        chdir: "{{ app_current_dir }}"
      become: yes
      become_user: "{{ deploy_user }}"
      when: has_build_script.rc == 0
      ignore_errors: yes

    - name: Reload PM2
      shell: pm2 reload {{ pm2_app_name }}
      become: yes
      become_user: "{{ deploy_user }}"

    - name: Wait for application
      wait_for:
        port: "{{ app_port }}"
        delay: 3
        timeout: 30

    - name: Health check
      uri:
        url: "http://localhost:{{ app_port }}"
        status_code: [200, 301, 302, 404]
        timeout: 10
      retries: 3
      delay: 5
      register: health_result
      ignore_errors: yes

    - name: Display health check result
      debug:
        msg: "Application is responding (Status: {{ health_result.status | default('unknown') }})"
      when: health_result is defined and not health_result.failed
