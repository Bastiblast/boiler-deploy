# Corrections du 11 Novembre 2025

## Problèmes Résolus

### 1. Validation d'inventaire ne fonctionnait pas
**Problème**: La touche `v` pour valider l'inventaire ne montrait rien et ne mettait pas à jour le status.

**Solution**: 
- Ajout de logs détaillés dans `workflow_view.go` pour tracer le processus de validation
- Mise à jour du status avant la validation pour afficher "Validating..."
- Amélioration de l'affichage du status avec détails sur les problèmes (IP, SSH, Port, Fields)

### 2. Variables Ansible manquantes dans l'inventaire généré
**Problème**: Le provisioning échouait avec `exit status 2` à cause de variables non définies.

**Solution**: Mise à jour de `internal/inventory/generator.go` pour générer toutes les variables nécessaires dans `group_vars/all.yml`:
- `app_releases_dir`, `app_current_dir`, `app_shared_dir`
- `node_env`
- `pm2_*` variables
- `ssl_domains`, `ssl_email`
- `nginx_worker_processes`, `nginx_worker_connections`, `nginx_keepalive_timeout`, `nginx_client_max_body_size`
- `enable_firewall` (false par défaut pour containers Docker)
- `backup_dir`, `backup_retention_days`

### 3. Template env.j2 assume la présence de serveurs DB
**Problème**: Le template `roles/nodejs/templates/env.j2` tentait d'accéder à `groups['dbservers']` même quand aucun serveur DB n'était configuré.

**Solution**: Ajout de conditions Jinja2 pour rendre la configuration DB optionnelle.

### 4. Outil de régénération d'inventaire
**Créé**: `cmd/regen-inventory/main.go` - permet de régénérer les `group_vars/all.yml` pour un environnement existant avec les nouvelles variables.

Usage: `./bin/regen-inventory <environment-name>`

## Problèmes Connus / À Résoudre

### 1. Provisioning échoue avec Nginx sur Docker
**Problème**: `nginx : Ensure Nginx is started and enabled` échoue dans un container Docker car systemd n'est pas disponible.

**Impact**: Le provisioning ne peut pas se terminer complètement dans un container lightweight.

**Solutions possibles**:
- Ajouter une condition pour skip l'activation de services si systemd n'est pas disponible
- Utiliser un container avec systemd (plus lourd)
- Créer une variante du playbook pour containers sans systemd

### 2. Check (touche 'c') ne semble pas démarrer
**Problème**: Après avoir sélectionné des serveurs et appuyé sur 'c', le status passe à "Verifying" mais reste bloqué.

**À vérifier**:
- Logs de l'orchestrator pour voir si l'action est bien ajoutée à la queue
- Vérifier que le processQueue tourne bien
- Tester le health check manuellement

### 3. Tab crash lors de l'édition de serveur (RÉSOLU)
Ce problème a été corrigé dans une session précédente.

## Améliorations Apportées

### 1. Logs détaillés
Ajout de logs avec préfixes clairs (`[VALIDATE]`, `[STATUS]`, `[ORCHESTRATOR]`, `[EXECUTOR]`) pour faciliter le debugging.

### 2. Affichage du status amélioré
Le status affiche maintenant des détails sur les problèmes lors de la validation:
- "✗ Not Ready (IP! SSH!)" - indique quels champs posent problème
- Status "⏳ Validating" pendant la validation
- Erreurs tronquées à 30 caractères pour rester lisible

### 3. Générateur d'inventaire plus complet
Le générateur crée maintenant des inventaires avec toutes les variables nécessaires pour les playbooks Ansible existants.

## Tests Réalisés

1. ✅ SSH vers container Docker fonctionne
2. ✅ Ansible ping fonctionne
3. ✅ Génération d'inventaire avec toutes les variables
4. ⚠️  Provisioning presque complet (échoue sur Nginx+systemd)
5. ❓ Check (à tester)
6. ❓ Validation dans l'UI (à tester avec app)

## Prochaines Étapes

1. Lancer l'application et tester la validation avec la touche 'v'
2. Débugger le check qui ne démarre pas
3. Résoudre le problème Nginx/systemd pour Docker
4. Tester un déploiement complet
5. Ajouter retry automatique ou manuel pour les erreurs de provisioning

## Commandes Utiles

```bash
# Build l'application
make build

# Régénérer l'inventaire pour un environnement
./bin/regen-inventory docker

# Tester le provisioning manuellement
ansible-playbook -i inventory/docker/hosts.yml playbooks/provision.yml --limit docker-web-01

# Voir les logs d'un provisioning
tail -100 logs/docker/docker-web-01_provision_<timestamp>.log

# SSH vers le container de test
ssh -i ~/.ssh/boiler_test_rsa -p 2222 root@127.0.0.1
```
